<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-frameset-thymeleaf-spring3-3.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<body class="metro">
<div class="page">
    <h1>
        <a th:href="@{/resident/neighbor/friend}"><i class="icon-arrow-left-3 fg-darker smaller"></i></a>
        好友申请
    </h1>

    <div class="grid fluid offset1">

        <!-- 我关注的物品 -->
        <div>
            <p>选择楼栋</p>
            <select id="building_selection" onchange="building_selection_changed(this)">
            </select>
            <p>选择单元</p>
            <select id="apartment_selection" onchange="apartment_selection_changed(this)">
            </select>
            <p>选择居民</p>
            <select id="citizen_selection">
            </select>

            <button onclick="apply()">添加</button>
        </div>
        <!-- End 我关注的物品 -->

    </div>

</div>

<div th:include="login_footer :: copy"></div>

<script type="application/javascript">
    var citizenId = 0;

    function apply() {
        if (citizenId != 0) {
            $.ajax({
                url: getUrl('rest/friends/' + currentUserId() + '/applications/' + citizenId),
                type: 'post',
                success: function() {
                    alert('好友申请已添加。');
                }
            })
        } else {
            alert("请完成选择！");
        }
    }

    function building_selection_changed(obj) {
        $.ajax({
            url: getUrl('rest/buildings/' + obj[obj.selectedIndex].value + '/apartments'),
            type: 'get',
            dataType: 'json',
            success: function(data) {
                var apartmentList = "";
                $.each(data, function(index, value) {
                    var apartment = "<option value=\"" + value.id + "\">" + value.name + "</option>";
                    apartmentList += apartment;
                });

                $('#apartment_selection').empty().append(apartmentList);
                $('#apartment_selection').selectedIndex = 0;
            }
        });
    };

    function apartment_selection_changed(obj) {
        $.ajax({
            url: getUrl('rest/apartment/' + obj[obj.selectedIndex].value + '/citizen'),
            type: 'get',
            dataType: 'json',
            success: function(data) {
                var apartmentList = "";
                $.each(data, function(index, value) {
                    var apartment = "<option value=\"" + value.id + "\">" + value.name + "</option>";
                    apartmentList += apartment;
                    apartmentList += apartment;
                });

                var citizen_sel = $('#citizen_selection')
                citizen_sel.empty().append(apartmentList);
                citizen_sel.selectedIndex = 0;
                citizenId = citizen_sel[citizen_sel.selectedIndex].value;
            }
        })
    };

    $(document).ready(function() {
        $.ajax({
            url: getUrl('rest/buildings'),
            type: 'get',
            dataType: 'json',
            success: function(data) {
                var bdList = "";
                $.each(data, function(index, value) {
                    var bd = "<option value=\"" + value.id + "\">" + value.name + "</option>";
                    bdList += bd;
                })

                $('#building_selection').append(bdList);
                $('#building_selection').selectedIndex = 0;
            }
        })
    });
</script>
</div>
</body>
</html>